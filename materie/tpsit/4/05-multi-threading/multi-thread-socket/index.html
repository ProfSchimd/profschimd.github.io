<!doctype html><html><head><meta charset=utf-8><title>Socket e multi-threading &ndash; Michele Schimd</title><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/spacelab/bootstrap.min.css rel=stylesheet><link href=https://profschimd.github.io/css/syntax.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css><script src=https://code.jquery.com/jquery-3.4.1.slim.min.js integrity=sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n crossorigin=anonymous></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class="d-flex flex-column min-vh-100"><header><nav class="p-1 navbar navbar-expand-lg navbar-dark bg-primary"><div class=container><a class=navbar-brand rel=author href=https://profschimd.github.io/>Michele Schimd</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>Materie</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a href=https://profschimd.github.io/materie/inf/ class=dropdown-item>Informatica</a></li><li><a href=https://profschimd.github.io/materie/sr/ class=dropdown-item>SR</a></li><li><a href=https://profschimd.github.io/materie/tpsit/ class=dropdown-item>TPSIT</a></li><li><a href=https://profschimd.github.io/materie/gpoi/ class=dropdown-item>GPOI</a></li><li><a href=https://profschimd.github.io/materie/ec/ class=dropdown-item>EC</a></li><li><a href=https://profschimd.github.io/materie/python/ class=dropdown-item>Python</a></li></ul></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>Classi</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a href=https://profschimd.github.io/classi/4ia/ class=dropdown-item>4IA</a></li><li><a href=https://profschimd.github.io/classi/4ic/ class=dropdown-item>4IC</a></li><li><a href=https://profschimd.github.io/classi/5ic/ class=dropdown-item>5IC</a></li><li><a href=https://profschimd.github.io/classi/5id/ class=dropdown-item>5ID</a></li><li><a href=https://profschimd.github.io/classi/anni-passati/ class=dropdown-item>Anni precedenti</a></li></ul></li><li class=nav-item><a class=nav-link href=https://profschimd.github.io/about/ role=button><i class="bi bi-info-circle"></i></a></li></ul></div></div></nav></header><div class="p-4 bg-primary" style="background-size:cover;background-position:50%;background-image:linear-gradient(to bottom,rgba(0,0,0,.3) 0%,rgba(0,0,0,.6) 100%),url(https://profschimd.github.io/img/zuccante_it.jpeg)"><div class=container><h1 class="display-4 text-white">Socket e multi-threading</h1></div></div><div class=bg-light><nav aria-label="breadcrumb mt-0"><div class=container><ol class=breadcrumb><li class=breadcrumb-item><a href=https://profschimd.github.io/>Home</a></li><li class=breadcrumb-item><a href=https://profschimd.github.io/materie/>Materie</a></li><li class=breadcrumb-item><a href=https://profschimd.github.io/materie/tpsit/>TPSIT</a></li><li class=breadcrumb-item><a href=https://profschimd.github.io/materie/tpsit/4/>TPSIT - Quarto Anno</a></li><li class=breadcrumb-item><a href=https://profschimd.github.io/materie/tpsit/4/05-multi-threading/>Multi threading in Java</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://profschimd.github.io/materie/tpsit/4/05-multi-threading/multi-thread-socket/>Socket e multi-threading</a></li></ol></nav></div><div class="container py-5"><main><div class=row><div class=col-10><aside><nav id=TableOfContents><ul><li><a href=#echo-client>Echo Client</a></li><li><a href=#echo-server>Echo Server</a></li><li><a href=#echo-server-con-multi-threading>Echo Server con multi-threading</a></li><li><a href=#link-utili>Link utili</a></li></ul></nav></aside></div><div class=col-2></div></div><article><div class=container style=text-align:justify><p>Un utilizzo frequente dei thread è in combinazione con i socket. Si pensi ad un Web Server
che riceve migliaia o più di richieste di connessioni in contemporanea. Come è possibile
gestire tutte queste richieste in modo veloce?</p><p>Una possibilità è che il server utilizzi più thread per gestire le varie connessioni.
Bisogna però stare attenti che l&rsquo;utilizzo di troppi thread può sovraccaricare il server
ottenendo l&rsquo;effetto opposto a quello desiderato.</p><p>Per capire meglio questo problema vediamo un problema &ldquo;classico&rdquo; di programmazione con i
socket: <em>la creazione di un Echo Client e di un Echo Server</em>. Un Echo Server non fa altro
che rimandare al Client tutto quello che quest&rsquo;ultimo spedisce (gli fa l&rsquo;<em>eco</em>, <em>echo</em> in
inglese). Un Echo Client è semplicemente un programma che manda messaggi ad un server ed
aspetta la risposta di questo. Di seguito ci concentreremo sulla realizzazione di un Echo
Client ed un Echo Server in Java</p><h2 id=echo-client>Echo Client</h2><p>Il seguente codice crea un Echo Client che si connette e manda stringhe (linee) sulla
<em>porta TCP</em> <code>23432</code> (impostata mediante la variabile <code>SERVER_LISTEN_PORT</code>).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>EchoClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SERVER_LISTEN_PORT</span> <span class=o>=</span> <span class=mi>23432</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>hostName</span> <span class=o>=</span> <span class=s>&#34;127.0.0.1&#34;</span><span class=o>;</span> <span class=c1>// stesso host del client
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Socket</span> <span class=n>client</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Socket</span><span class=o>(</span><span class=n>hostName</span><span class=o>,</span> <span class=n>SERVER_LISTEN_PORT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>InputStreamReader</span> <span class=n>isr</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InputStreamReader</span><span class=o>(</span><span class=n>client</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>BufferedReader</span> <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedReader</span><span class=o>(</span><span class=n>isr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>PrintWriter</span> <span class=n>out</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PrintWriter</span><span class=o>(</span><span class=n>client</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>(),</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Scanner</span> <span class=n>scanner</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Scanner</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>line</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Spedisco: &#34;</span> <span class=o>+</span> <span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>line</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Ricevuto: &#34;</span> <span class=o>+</span> <span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>line</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;exit&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>scanner</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>out</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>in</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>isr</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>client</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><p>Il codice del client è relativamente semplice.</p><ol><li>Inizialmente, viene effettuata la connessione (<code>new Socket</code>) e vengono creati gli stream
da cui ricevere dal server (<code>BufferedReader in</code>) e su cui spedire al server <code>PrintWriter out</code>.
Inoltre viene creato uno <code>Scanner</code> per la lettura da tastiera.</li><li>A questo punto si avvia un ciclo infinito (<code>while(true)</code>) che<ol><li>legge da tastiera e stampa a video quanto letto</li><li>manda sulla connessione quanto letto e</li><li>riceve da remoto stampando a schermo quanto ricevuto.</li></ol></li><li>Il ciclo infinito termina quando a tastiera viene digitato <code>exit</code>. Al termine del ciclo gli
stream e la connessione vengono chiusi prima che il programma termini.</li></ol><p>Il programma sopra è corretto, ma non funziona se prima non viene
avviato un server che accetta connessioni TCP sulla porta indicata. Senza server, il client
genera un errore simile al seguente</p><pre><code>java.net.ConnectException: Connection refused
    at java.base/sun.nio.ch.Net.connect0(Native Method)
    at java.base/sun.nio.ch.Net.connect(Net.java:579)
    at java.base/sun.nio.ch.Net.connect(Net.java:568)
    at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:588)
    at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327)
    at java.base/java.net.Socket.connect(Socket.java:633)
    at java.base/java.net.Socket.connect(Socket.java:583)
    at java.base/java.net.Socket.&lt;init&gt;(Socket.java:507)
    at java.base/java.net.Socket.&lt;init&gt;(Socket.java:287)
    at EchoClient.main(EchoClient.java:12)
</code></pre><p>da dove si capisce che la connessione è stata rifiutata (<code>connection refused</code>). Il passo
successivo, quindi, è scrivere il programma Echo Server.</p><h2 id=echo-server>Echo Server</h2><p>Il codice di un server (<em>single thread</em>, cioè che utilizza solo il thread principale) è
presentato di seguito.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SingleThreadSocket</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SERVER_LISTEN_PORT</span> <span class=o>=</span> <span class=mi>23432</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerSocket</span> <span class=n>server</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=n>SERVER_LISTEN_PORT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Socket</span> <span class=n>socket</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>InputStreamReader</span> <span class=n>isr</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InputStreamReader</span><span class=o>(</span><span class=n>socket</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>BufferedReader</span> <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedReader</span><span class=o>(</span><span class=n>isr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>PrintWriter</span> <span class=n>out</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PrintWriter</span><span class=o>(</span><span class=n>socket</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>(),</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>line</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span><span class=o>((</span><span class=n>line</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readLine</span><span class=o>())</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Ricevuto: &#34;</span> <span class=o>+</span> <span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>line</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;exit&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>out</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>in</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>isr</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>socket</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>server</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><p>Come si vede, il server è molto simile al client, la vera differenza è nelle righe<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServerSocket</span> <span class=n>server</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=n>SERVER_LISTEN_PORT</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Socket</span> <span class=n>socket</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span></span></span></code></pre></td></tr></table></div></div>permettono al server di <em>mettersi in ascolto</em> sulla porta indicata (la stessa del client)
e creare un <code>Socket</code> per le comunicazioni non appena il primo client apra una connessione
TCP su quella porta.</p><div class="alert alert-primary" markdown=1><h5 class=no_toc><i class="bi bi-pencil-square"></i> Esercizio</strong></h5><p><p>Per vedere cosa succede quando due client provano a connettersi allo stesso server:</p><ol><li>compila avvia il server <code>SingleThreadSocket.java</code></li><li>compila il file <code>EchoClient.java</code></li><li>Avvia due istanze di EchoClient
Cosa succede se si prova a scrivere qualcosa sulla prima istanza EchoClient? Cosa succede
se si scrive sulla seconda istanza? Perché succede questo?</li></ol></p></div><h2 id=echo-server-con-multi-threading>Echo Server con multi-threading</h2><p>Se si svolge l&rsquo;esercizio alla fine del paragrafo precedente, si vede come la soluzione
fin qui proposta non permetta di connettere più client allo stesso server. Questo è
tipicamente un problema perché i server sono proprio pensati per gestire più client
contemporaneamente.</p><p>Il problema è che ogni nuovo client richiede che vengano propriamente gestiti gli
stream associati (<code>in</code> e <code>out</code>), ma questo è molto difficile con un solo thread.
La soluzione più logica, quindi, è quella di usare più thread, uno per ogni client
connesso (si veda il riquadro Attenzione alla fine del paragrafo).</p><p>Per realizzare questa soluzione dobbiamo come prima cosa creare un <code>Thread</code> che
si occupi di gestire la comunicazione con uno specifico client.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SocketThread</span> <span class=kd>extends</span> <span class=n>Thread</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Socket</span> <span class=n>socket</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>BufferedReader</span> <span class=n>in</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>PrintWriter</span> <span class=n>out</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SocketThread</span><span class=o>(</span><span class=n>Socket</span> <span class=n>socket</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>socket</span> <span class=o>=</span> <span class=n>socket</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>InputStreamReader</span> <span class=n>isr</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InputStreamReader</span><span class=o>(</span><span class=n>socket</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedReader</span><span class=o>(</span><span class=n>isr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PrintWriter</span><span class=o>(</span><span class=n>socket</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>(),</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>line</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>((</span><span class=n>line</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readLine</span><span class=o>())</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;[R]: &#34;</span> <span class=o>+</span> <span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>line</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;exit&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>out</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>in</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>socket</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><p>Si nota subito come il codice sia quasi tutto il codice del server single thread
però organizzato tra il costruttore <code>SocketThread</code> e il metodo <code>run</code>. Proprio
per questo motivo il server ora è molto più semplice<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MultiThreadSocket</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SERVER_LISTEN_PORT</span> <span class=o>=</span> <span class=mi>23432</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerSocket</span> <span class=n>server</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=n>SERVER_LISTEN_PORT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Socket</span> <span class=n>socket</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SocketThread</span><span class=o>(</span><span class=n>socket</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>t</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div>L&rsquo;unica cosa rimasta in questo codice è la parte di ascolto (<code>server.accept()</code>) di una
nuova connessione. Non appena se ne verifica una, l&rsquo;oggetto di tipo <code>Socket</code> restituito
da <code>accept()</code> viene utilizzato per creare ed avviare un nuovo thread del tipo <code>SocketThread</code>
sopra. Fatto questo, il thread principale del server si mette subito in attesa di nuove
connessione, mentre le comunicazioni con il client appena connesso vengono gestite dal
thread appena avviato.
​</p><div class="alert alert-danger" markdown=1><h5 class="alert-danger no_toc"><i class="bi bi-exclamation-triangle"></i> Attenzione</strong></h5><p>Avviare un thread per ogni connessione può sembrare la scelta più ovvia, ma se il server
deve gestire molte connessioni contemporaneamente (centinaia o migliaia), bisogna garantire
che non si generino troppi thread che causerebbero il sovraccarico del server, fino a
renderlo inutilizzabile.</p></div><h2 id=link-utili>Link utili</h2><ul><li><a href=https://github.com/ProfSchimd/4id_2021_2022/tree/master/thread/socket target=_blank rel=noopener>Codice su GitHub</a></li></ul></div></article><nav class="mx-5 my-3"><div class=card><h5 class=card-header>Indice di Multi threading in Java</h5><ul class="list-group list-group-flush"><li class="list-group-item list-group-item-primary"><strong><a href=https://profschimd.github.io/materie/tpsit/4/05-multi-threading/multi-thread-socket/>> Socket e multi-threading</a></strong></li><li class=list-group-item><a href=https://profschimd.github.io/materie/tpsit/4/05-multi-threading/programmazione_asincrona/>Programmazione asincrona</a></li></ul><div class=card-footer><a class="btn btn-primary" href=https://profschimd.github.io/materie/tpsit/4/05-multi-threading/>Index</a></div></div></nav></main></div><div class="py-3 border-top bg-light mt-auto"><div class=container><div class=row><div class=col-sm><ul class=list-unstyled><li>Michele Schimd &copy; 2022</li><li><a class=pr-1 href=mailto:michele.schimd@itiszuccante.edu.it><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" fill="currentcolor" class="bi bi-at" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 012 2h12a2 2 0 011.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83.191 12.857A2 2 0 002 14h12a2 2 0 001.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"/></svg></a><a class=pr-1 rel=me href=https://github.com/ProfSchimd target=_blank title=ProfSchimd alt=GitHub><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" fill="currentcolor" class="bi bi-github" viewBox="0 0 16 16"><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><a class=pr-1 rel=me href=https://www.linkedin.com/in/michele-schimd-44a85160 target=_blank title=michele-schimd-44a85160 alt=Linkedin><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" fill="currentcolor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526.0 1.175.0h13.65C15.474.0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487.0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837.0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822.0-1.359.54-1.359 1.248.0.694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869.0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274.0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54.0 01.016-.025V6.169h-2.4c.03.678.0 7.225.0 7.225h2.4z"/></svg></a><a class=pr-1 rel=me href=https://stackoverflow.com/users/18081937 target=_blank title=18081937><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" fill="currentcolor" class="bi bi-stack-overflow" viewBox="0 0 16 16"><path d="M12.412 14.572V10.29h1.428V16H1v-5.71h1.428v4.282h9.984z"/><path d="M3.857 13.145h7.137v-1.428H3.857v1.428zM10.254.0 9.108.852l4.26 5.727 1.146-.852L10.254.0zm-3.54 3.377 5.484 4.567.913-1.097L7.627 2.28l-.914 1.097zM4.922 6.55l6.47 3.013.603-1.294-6.47-3.013-.603 1.294zm-.925 3.344 6.985 1.469.294-1.398-6.985-1.468-.294 1.397z"/></svg></a></li><li><span style=font-size:small><em>Ultimo aggiornamento: 01/12/2022</em></span></li></ul></div><div class="col-lg text-right"><ul class=list-unstyled><li>Materiale di studio e di esercizio per gli alunni dello Zuccante.</li></ul><div><p><a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/><img style=float:right alt="Creative Commons License" src=https://i.creativecommons.org/l/by-nc/4.0/88x31.png></a></div></p></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js integrity=sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js integrity=sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF crossorigin=anonymous></script></body></html>